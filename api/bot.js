import { Telegraf } from 'telegraf';

const BOT_TOKEN = process.env.BOT_TOKEN;
const bot = new Telegraf(BOT_TOKEN);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start(async (ctx) => {
    
    console.log('Received start command from:', userId);

    // Ð¡Ñ€Ð°Ð·Ñƒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    // await ctx.reply('ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÐµÐ¼! Ð’Ñ…Ð¾Ð´ Ð² ÐºÐ»ÑƒÐ± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!');

    // ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    await ctx.reply(
        `ðŸ† **Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð£Ð§ÐÐ¡Ð¢ÐÐ˜ÐšÐžÐ’ ÐÐšÐ¦Ð˜Ð˜**\n\n` +
        `ÐšÐ¾Ð½ÐºÑƒÑ€Ñ "ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº Ð¼ÐµÑÑÑ†Ð°" Ð¾Ñ‚ ÐºÐ»ÑƒÐ±Ð° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð²Ð°Ð½Ð¸Ñ "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½" Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½.\n` +
        `23 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ Ð¼Ñ‹ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ð»Ð¸ Ñ€Ð¾Ð·Ñ‹Ð³Ñ€Ñ‹Ñˆ ÑÑ€ÐµÐ´Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð².\n\n` +
        `**ÐŸÐžÐ‘Ð•Ð”Ð˜Ð¢Ð•Ð›Ð¬:** tg://openmessage?user_id=6705882256` +
        `*ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÐµÐ¼! Ð¡ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ¶ÑƒÑ‚ÑÑ Ð´Ð»Ñ Ð²Ñ€ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð·Ð°.*\n\n` +
        `**Ð“Ð›ÐÐ’ÐÐ«Ð™ ÐŸÐ Ð˜Ð—:**\n` +
        `- 2 Ð¿Ð°Ñ€Ñ‹ ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ñ… Ð¾Ð±Ñ‚ÑÐ³Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ñ… Ð¿Ð»Ð°Ð²Ð¾Ðº: Ð¼Ð¾Ð´ÐµÐ»ÑŒ "BEEZBARA" Ð¸ Ñ„Ð¸Ñ€Ð¼ÐµÐ½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð¾Ð¼ ÐºÐ»ÑƒÐ±Ð°.\n` +
        `- Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ð° 7 Ð½Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð² Ð¿Ð°Ñ€Ðµ Ñ Ð½Ð°ÑˆÐ¸Ð¼Ð¸ Ð»ÑƒÑ‡ÑˆÐ¸Ð¼Ð¸ Ð¿Ð»Ð¾Ð²Ñ†Ð°Ð¼Ð¸.\n` +
        `- ÐŸÐ¾Ð¶Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚ Ð½Ð° Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ñ Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼ **Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸ÐµÐ¼ ÐŸÐ¾Ñ‚Ð°Ð¿Ð¾Ð²Ñ‹Ð¼** (ÑÑ‚Ð°Ð¶ 5 Ð»ÐµÑ‚, Ð¼Ð°ÑÑ‚ÐµÑ€ ÑÐ¿Ð¾Ñ€Ñ‚Ð°).\n\n` +
        `*Ð”Ð°Ð½Ð½Ñ‹Ð¹ Ð±Ð¾Ñ‚ Ð±Ñ‹Ð» Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð¾Ð¼ Ð´Ð»Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÐºÐ¾Ð½ÐºÑƒÑ€Ñ.*\n` +
        `*Ð¡ 25 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ Ð¾Ð½ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.*\n\n` +
        `**ÐžÑ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»ÑƒÐ± "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½" Ð¶Ð´Ñ‘Ñ‚ Ð²Ð°Ñ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:**\n` +
        `ÐšÐ°Ð»Ð¸Ð½Ð¸Ð½Ð³Ñ€Ð°Ð´, ÑƒÐ». ÐÐ°Ð±ÐµÑ€ÐµÐ¶Ð½Ð°Ñ, 15 (Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÑÑÐµÐ¹Ð½Ð° "Ð’Ð¾Ð»Ð½Ð°", 3 ÑÑ‚Ð°Ð¶).\n` +
        `**ÐŸÐµÑ€Ð²Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‡Ð»ÐµÐ½Ð¾Ð² ÐºÐ»ÑƒÐ±Ð°:** 28 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ, 19:00.\n\n` +
        `*Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð·Ð° Ð¿Ð¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»ÑŽ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¸Ð¼ÐµÑ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐµÐ±Ðµ Ð¿Ð°ÑÐ¿Ð¾Ñ€Ñ‚ Ð¸ ÑÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾Ð±ÑƒÐ²ÑŒ.*\n\n` +
        `Ð¡ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼,\n` +
        `Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸Ð¹,\n` +
        `CEO ÐºÐ»ÑƒÐ±Ð° "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½".`,
        { parse_mode: 'Markdown' }
    );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð»ÑŽÐ±Ñ‹Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
    // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð½Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ
    if (!ctx.message.text.startsWith('/')) {
        await ctx.reply('Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start');
    }
});

// Ð”Ð»Ñ Vercel - Ð²ÐµÐ±Ñ…ÑƒÐº Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº
export default async function handler(req, res) {
    if (req.method === 'POST') {
        console.log('Received webhook update:', JSON.stringify(req.body));
        try {
            await bot.handleUpdate(req.body);
            res.status(200).json({ ok: true });
        } catch (error) {
            console.error('Error handling update:', error);
            res.status(500).json({ error: 'Internal Server Error' });
        }
    } else {
        res.status(200).json({ 
            message: 'Bot is running',
            usage: 'Send POST requests to this endpoint with Telegram updates'
        });
    }
}

// Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ polling
if (process.env.VERCEL !== '1') {
    bot.launch().then(() => {
        console.log('Bot started in polling mode');
    });
    
    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));
}
