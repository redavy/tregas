import { Telegraf } from 'telegraf';

const BOT_TOKEN = process.env.BOT_TOKEN;
const bot = new Telegraf(BOT_TOKEN);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start(async (ctx) => {
    const userId = ctx.from.id;
    console.log('Received start command from:', userId);
    
    await ctx.reply('Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÑÐµÑ€Ð²Ð¸Ñ Â«ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ñ Ð´Ð¾Ð¼Ð°ÑˆÐºÐ¾Ð¹Â»! Ð”Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð½Ðµ Ñ€Ð¾Ð±Ð¾Ñ‚.');
    
    const { Markup } = await import('telegraf');
    
    await ctx.reply(
        'ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ: ÐšÐ°Ðº Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¼ÐµÑÑ‚Ð¾, Ð³Ð´Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ÑÑ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ð¼ Ð¿Ð»Ð°Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð² Ð¾Ð±Ñ‚ÑÐ³Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ñ… ÐºÑƒÐ¿Ð°Ð»ÑŒÐ½Ð¸ÐºÐ°Ñ…?',
        Markup.inlineKeyboard([
            [Markup.button.callback('Ð‘Ð°ÑÑÐµÐ¹Ð½', 'answer_1')],
            [Markup.button.callback('Ð’Ð¾Ð´Ð½Ñ‹Ð¹ ÑÑ‚Ð°Ð´Ð¸Ð¾Ð½', 'answer_2')],
            [Markup.button.callback('Ð“ÐµÐ¹-ÐºÐ»ÑƒÐ± "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½"', 'answer_3')]
        ])
    );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
bot.action('answer_1', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText('ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·!');
});

bot.action('answer_2', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText('ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·!');
});

bot.action('answer_3', async (ctx) => {
    const userId = ctx.from.id;
    const userName = ctx.from.first_name || 'Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸Ðº';
    
    await ctx.answerCbQuery();
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    await ctx.editMessageText('ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÐµÐ¼! Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð² ÐºÐ»ÑƒÐ±Ðµ Â«ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½Â» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!');
    
    // ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    await ctx.reply(
        `ðŸ† **Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð£Ð§ÐÐ¡Ð¢ÐÐ˜ÐšÐžÐ’ ÐÐšÐ¦Ð˜Ð˜**\n\n` +
        `ÐšÐ¾Ð½ÐºÑƒÑ€Ñ "ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº Ð¼ÐµÑÑÑ†Ð°" Ð¾Ñ‚ ÐºÐ»ÑƒÐ±Ð° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð²Ð°Ð½Ð¸Ñ "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½" Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½.\n` +
        `23 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ Ð¼Ñ‹ Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ð»Ð¸ Ñ€Ð¾Ð·Ñ‹Ð³Ñ€Ñ‹Ñˆ ÑÑ€ÐµÐ´Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… ÑƒÑ‡Ð°ÑÑ‚ÐºÐ¾Ð².\n\n` +
        `**ÐŸÐžÐ‘Ð•Ð”Ð˜Ð¢Ð•Ð›Ð¬:** [${userName}](tg://user?id=${userId})\n` +
        `*ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÐµÐ¼! Ð¡ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ¶ÑƒÑ‚ÑÑ Ð´Ð»Ñ Ð²Ñ€ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð·Ð°.*\n\n` +
        `**Ð“Ð›ÐÐ’ÐÐ«Ð™ ÐŸÐ Ð˜Ð—:**\n` +
        `- 2 Ð¿Ð°Ñ€Ñ‹ ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ñ… Ð¾Ð±Ñ‚ÑÐ³Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ñ… Ð¿Ð»Ð°Ð²Ð¾Ðº: Ð¼Ð¾Ð´ÐµÐ»ÑŒ "BEEZBARA" Ð¸ Ñ„Ð¸Ñ€Ð¼ÐµÐ½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð¾Ð¼ ÐºÐ»ÑƒÐ±Ð°.\n` +
        `- Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ð° 7 Ð½Ð¾Ñ‡Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð² Ð¿Ð°Ñ€Ðµ Ñ Ð½Ð°ÑˆÐ¸Ð¼Ð¸ Ð»ÑƒÑ‡ÑˆÐ¸Ð¼Ð¸ Ð¿Ð»Ð¾Ð²Ñ†Ð°Ð¼Ð¸.\n` +
        `- ÐŸÐ¾Ð¶Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚ Ð½Ð° Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ñ Ñ‚Ñ€ÐµÐ½ÐµÑ€Ð¾Ð¼ **Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸ÐµÐ¼ ÐŸÐ¾Ñ‚Ð°Ð¿Ð¾Ð²Ñ‹Ð¼** (ÑÑ‚Ð°Ð¶ 5 Ð»ÐµÑ‚, Ð¼Ð°ÑÑ‚ÐµÑ€ ÑÐ¿Ð¾Ñ€Ñ‚Ð°).\n\n` +
        `*Ð”Ð°Ð½Ð½Ñ‹Ð¹ Ð±Ð¾Ñ‚ Ð±Ñ‹Ð» Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð¾Ð¼ Ð´Ð»Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÐºÐ¾Ð½ÐºÑƒÑ€Ñ.*\n` +
        `*Ð¡ 25 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ Ð¾Ð½ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.*\n\n` +
        `**ÐžÑ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»ÑƒÐ± "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½" Ð¶Ð´Ñ‘Ñ‚ Ð²Ð°Ñ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:**\n` +
        `ÐšÐ°Ð»Ð¸Ð½Ð¸Ð½Ð³Ñ€Ð°Ð´, ÑƒÐ». ÐÐ°Ð±ÐµÑ€ÐµÐ¶Ð½Ð°Ñ, 15 (Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÑÑÐµÐ¹Ð½Ð° "Ð’Ð¾Ð»Ð½Ð°", 3 ÑÑ‚Ð°Ð¶).\n` +
        `**ÐŸÐµÑ€Ð²Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‡Ð»ÐµÐ½Ð¾Ð² ÐºÐ»ÑƒÐ±Ð°:** 28 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ, 19:00.\n\n` +
        `*Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð·Ð° Ð¿Ð¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»ÑŽ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¸Ð¼ÐµÑ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐµÐ±Ðµ Ð¿Ð°ÑÐ¿Ð¾Ñ€Ñ‚ Ð¸ ÑÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾Ð±ÑƒÐ²ÑŒ.*\n\n` +
        `Ð¡ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼,\n` +
        `Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸Ð¹,\n` +
        `CEO ÐºÐ»ÑƒÐ±Ð° "ÐÐºÐ²Ð°Ð¼Ð°Ñ€Ð¸Ð½".`,
        { parse_mode: 'Markdown' }
    );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
    await ctx.reply('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ.');
});

// Ð”Ð»Ñ Vercel - Ð²ÐµÐ±Ñ…ÑƒÐº Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº
export default async function handler(req, res) {
    if (req.method === 'POST') {
        console.log('Received webhook update:', JSON.stringify(req.body));
        try {
            await bot.handleUpdate(req.body);
            res.status(200).json({ ok: true });
        } catch (error) {
            console.error('Error handling update:', error);
            res.status(500).json({ error: 'Internal Server Error' });
        }
    } else {
        res.status(200).json({ 
            message: 'Bot is running',
            usage: 'Send POST requests to this endpoint with Telegram updates'
        });
    }
}

// Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ polling
if (process.env.VERCEL !== '1') {
    bot.launch().then(() => {
        console.log('Bot started in polling mode');
    });
    
    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));
}
