import { Telegraf } from 'telegraf';

const BOT_TOKEN = process.env.BOT_TOKEN;
const bot = new Telegraf(BOT_TOKEN);

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö)
const userTimers = new Map();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.start(async (ctx) => {
    const userId = ctx.from.id;
    console.log('Received start command from:', userId);
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–∞–π–º–µ—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (userTimers.has(userId)) {
        const timers = userTimers.get(userId);
        timers.forEach(timerId => clearTimeout(timerId));
        userTimers.delete(userId);
    }
    
    await ctx.reply('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ—Ä–≤–∏—Å ¬´HW As¬ª! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç.');
    
    const { Markup } = await import('telegraf');
    
    await ctx.reply(
        '–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å: –ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ—Å—Ç–æ, –≥–¥–µ –≥—Ä—É–ø–ø–∞ –º—É–∂—á–∏–Ω –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –ø–ª–∞–≤–∞–Ω–∏–µ–º –≤ –æ–±—Ç—è–≥–∏–≤–∞—é—â–∏—Ö –∫—É–ø–∞–ª—å–Ω–∏–∫–∞—Ö?',
        Markup.inlineKeyboard([
            [Markup.button.callback('–ë–∞—Å—Å–µ–π–Ω', 'answer_1')],
            [Markup.button.callback('–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω', 'answer_2')],
            [Markup.button.callback('–ì–µ–π-–∫–ª—É–± "–ê–∫–≤–∞–º–∞—Ä–∏–Ω"', 'answer_3')]
        ])
    );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
bot.action('answer_1', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
});

bot.action('answer_2', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!');
});

bot.action('answer_3', async (ctx) => {
    const userId = ctx.from.id;
    await ctx.answerCbQuery();
    await ctx.editMessageText('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –∫–ª—É–±–µ ¬´–ê–∫–≤–∞–º–∞—Ä–∏–Ω¬ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. –°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å!');
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    startMessageTimers(userId, ctx);
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
function startMessageTimers(userId, ctx) {
    const timers = [];
    
    // –°–æ–æ–±—â–µ–Ω–∏—è —Å —Ç–∞–π–º–µ—Ä–∞–º–∏ (–≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
    const messages = [
        { time: 2 * 60 * 1000, text: `1. –í–∏—Ç–∞–ª–∏–π, —Ç—Ä–µ–Ω–µ—Ä (45 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ü—Ä–∏–≤–µ—Ç, –º—ã—à–∫–∞. –Ø —Ç–≤–æ–π –Ω–æ–≤—ã–π —Ç—Ä–µ–Ω–µ—Ä. –ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è—Ç—Å—è –ø–æ 3 —á–∞—Å–∞, –∏ —è –Ω–µ –ø—Ä–∏–∑–Ω–∞—é —Å–ª–æ–≤–∞ "–Ω–µ –º–æ–≥—É". –ì–æ—Ç–æ–≤—å —Å–≤–æ–∏ –º—è–≥–∫–∏–µ –º–µ—Å—Ç–∞ –∫ —Å–µ—Ä—å–µ–∑–Ω–æ–π —Ä–∞–±–æ—Ç–µ. –ö—É–ø–∞–ª—å–Ω–∞—è —à–∞–ø–æ—á–∫–∞ –Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 2` },
        { time: 4 * 60 * 1000, text: `2. –≠–ª—å –ü–æ–º–∏–¥–æ—Ä–æ (32 –≥–æ–¥–∞, –ë–∞—Ä—Å–µ–ª–æ–Ω–∞)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´Hola, –æ–≥–Ω–µ–≥—Ä–∏–≤—ã–π! –Ø —Å–≥–æ—Ä–∞—é –æ—Ç —Å—Ç—Ä–∞—Å—Ç–∏, –∫–∞–∫ –ø–æ–º–∏–¥–æ—Ä –Ω–∞ —Å–æ–ª–Ω—Ü–µ. –í –º–æ–µ–π —Å—Ç—É–¥–∏–∏ –µ—Å—Ç—å –¥–∂–∞–∫—É–∑–∏ –Ω–∞ –¥–≤–æ–∏—Ö –∏ –∫–æ–∂–∞–Ω—ã–π –¥–∏–≤–∞–Ω –¥–ª—è... –æ—Ç–¥—ã—Ö–∞ –ø–æ—Å–ª–µ –≤–æ–¥–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä. –ü—Ä–∏–µ–∑–∂–∞–π, –±—É–¥–µ–º —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å —Ç–∞–Ω–≥–æ –±–µ–∑ —Ç—Ä—É—Å–æ–≤.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 4` },
        { time: 4 * 60 * 1000, text: `3. –ö–æ—Å—Ç—è-–ü—á–µ–ª–∞ (19 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ñ–∂—É-–∂–∂—É, —Å–ª–∞–¥–∫–∏–π –º–æ–π –º–∞–ª—å—á–∏–∫! –Ø –æ–ø—ã–ª—è—é –≤—Å–µ —Ü–≤–µ—Ç—ã –≤ –Ω–∞—à–µ–º —Å–∞–¥—É. –ú–æ–π —É–ª–µ–π —Ç–µ–ø–ª—ã–π –∏ –ª–∏–ø–∫–∏–π –æ—Ç –º–µ–¥–∞. –•–æ—á–µ—à—å –∑–∞–ª–µ–∑—Ç—å –≤–Ω—É—Ç—Ä—å –∏ –ø–æ–º–æ—á—å –º–Ω–µ —Å –º–µ–¥–æ—Å–±–æ—Ä–æ–º? –ë—É–¥—É –∂–∞–ª–∏—Ç—å –Ω–µ–∂–Ω–æ.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 4 (–≤ –ø–∞—Ä–µ —Å –≠–ª—å –ü–æ–º–∏–¥–æ—Ä–æ)` },
        { time: 7 * 60 * 1000, text: `4. –ê–Ω–¥—Ä–µ–π –ò–≥–æ—Ä–µ–≤–∏—á (–î–∏—Ä–µ–∫—Ç–æ—Ä –±–∞—Å—Å–µ–π–Ω–∞, 51 –≥–æ–¥)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ú–∞–ª—å—á–∏–∫, —è –Ω–∞–±–ª—é–¥–∞—é –∑–∞ —Ç–æ–±–æ–π —Å –º–æ–Ω–∏—Ç–æ—Ä–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ 305. –£ –º–µ–Ω—è –µ—Å—Ç—å —Å–≤—è–∑–∫–∞ –∫–ª—é—á–µ–π –æ—Ç –≤—Å–µ—Ö –ø–æ–¥—Å–æ–±–æ–∫. –•–æ—á–µ—à—å –ø—Ä–∏–≤–∞—Ç–Ω—É—é —ç–∫—Å–∫—É—Ä—Å–∏—é –≤ –º–æ—é "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∫–æ–º–Ω–∞—Ç—É"? –ü—Ä–∏—Ö–æ–¥–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è. –ë–µ–∑ –ø–ª–∞–≤–æ–∫.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 7` },
        { time: 12 * 60 * 1000, text: `5. –°–µ—Ä—ë–∂–∞-–ü–æ—ç—Ç (22 –≥–æ–¥–∞)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–¢–≤–æ–µ —Ç–µ–ª–æ ‚Äì —ç—Ç–æ —Å–æ–Ω–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —è —Ö–æ—á—É —á–∏—Ç–∞—Ç—å –Ω–∞–∏–∑—É—Å—Ç—å –≥—É–±–∞–º–∏... –í —Ä–∞–∑–¥–µ–≤–∞–ª–∫–µ, –Ω–∞ –º–æ–∫—Ä–æ–π –ª–∞–≤–∫–µ. –Ø –Ω–∞–ø–∏—à—É –æ —Ç–µ–±–µ –ø–æ—ç–º—É "–û–¥–∞ –≤–ª–∞–∂–Ω—ã–º —Ç—Ä—É—Å–∞–º". –û—Ç–≤–µ—Ç—å –º–Ω–µ, –º–æ–π –≥–æ—Ñ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ê–ø–æ–ª–ª–æ–Ω.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 12` },
        { time: 15 * 60 * 1000, text: `11. –î–∏–º–∞—Å –ë–∞—Ä—Ç–µ–ª—å (18 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–û–ª–µ–≥, —Ç—ã —á–µ —Ç—É—Ç –∑–∞–±—ã–ª, –±–ª#—Ç—å? –≠—Ç–æ –∂–µ –≥–µ–π-–∫–ª—É–±! –¢—ã —á–µ, –æ—Ö—É–µ–ª –≤–æ–æ–±—â–µ? –î–∏–º–∞ –ë–∞—Ä—Ç–µ–ª—å, —Å —Å–æ—Å–µ–¥–Ω–µ–≥–æ –ø–æ–¥—ä–µ–∑–¥–∞. –ú–∞–º–∫–∞ —Ç–≤–æ—è –≤ –∫—É—Ä—Å–µ, –∫—É–¥–∞ —Ç—ã –∑–∞–ø–∏—Å–∞–ª—Å—è?¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 15 (—ç—Ç–æ –±—É–¥–µ—Ç –º–æ—â–Ω—ã–π —É–¥–∞—Ä)` },
        { time: 20 * 60 * 1000, text: `6. –ú–∞–∫—Å–∏–º –£–ø–æ—Ä–Ω—ã–π (–°—Ç—Ä–æ–∏—Ç–µ–ª—å, 28 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–°–ª—É—à–∞–π —Å—é–¥–∞, –∫—Ä–∞—Å–∞–≤—á–∏–∫. –£ –º–µ–Ω—è –µ—Å—Ç—å –ø–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–±—Ä–∏—Ä—É–µ—Ç –Ω–∞ 15 —Ä–µ–∂–∏–º–∞—Ö. –ü—Ä–∏—Ö–æ–¥–∏ –Ω–∞ –º–æ–π –æ–±—ä–µ–∫—Ç, –∑–∞–π–º–µ–º—Å—è "–º–æ–∫—Ä—ã–º–∏" —Ä–∞–±–æ—Ç–∞–º–∏. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É—é, —Ü–µ–º–µ–Ω—Ç –≤ —à—Ç–∞–Ω–∞—Ö –∑–∞—Å—Ç—ã–Ω–µ—Ç –Ω–µ —Å—Ä–∞–∑—É.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 20` },
        { time: 25 * 60 * 1000, text: `7. –î–º–∏—Ç—Ä–∏–π –®–µ–≤—á–µ–Ω–∫–æ (–ò—Å—Ç–æ—Ä–∏–∫, 41 –≥–æ–¥)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π. –Ø –ø—Ä–∞–∫—Ç–∏–∫—É—é –¥—Ä–µ–≤–Ω–µ—Ä–∏–º—Å–∫–∏–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏. –í –±–∞–Ω–µ, —Å –≤–µ–Ω–∏–∫–∞–º–∏ –∏ –º–∞—Å–ª–∞–º–∏. –ò—â—É —Å–µ–Ω–∞—Ç–æ—Ä–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∑–∞–∫–æ–Ω–æ–≤ –∏ –≤–∑–∞–∏–º–Ω–æ–≥–æ —Ä–∞—Å—Ç–∏—Ä–∞–Ω–∏—è. –ù–∞—à–∞ –¥—Ä—É–∂–±–∞ –±—É–¥–µ—Ç –∫—Ä–µ–ø—á–µ, —á–µ–º —Å—Ç–µ–Ω—ã –°–ø–∞—Ä—Ç—ã.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 25` },
        { time: 30 * 60 * 1000, text: `8. –°—Ç–∞—Å (–ë–∞—Ä–º–µ–Ω, 25 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–≠–π, –¥–µ—Ç–∫–∞! –Ø —Å–º–µ—à–∞—é –¥–ª—è —Ç–µ–±—è –∫–æ–∫—Ç–µ–π–ª—å '–ì–æ–ª—É–±–∞—è —Ñ–∏–µ—Å—Ç–∞': —Ç–µ–∫–∏–ª–∞, —Å–∏–Ω–∏–π –∫—é—Ä–∞—Å–∞–æ –∏ –º–æ–π –æ—Å–æ–±—ã–π —Å–æ–∫. –ë—É–¥–µ—Ç –≥–æ—Ä—è—á–æ –∏ –ø–µ–Ω–æ–æ–æ. –û—Å—Ç–∞–Ω–µ—à—å—Å—è –Ω–æ—á—å—é –≤—ã—Ç–∏—Ä–∞—Ç—å –º–æ–∏ —Å—Ç–æ–ª–∏–∫–∏?¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 30` },
        { time: 35 * 60 * 1000, text: `12. –î–º–∏—Ç—Ä–∏–π –ü–æ—Ç–∞–ø–æ–≤ (–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–Ø ‚Äî –¢–ï–†–ú–ò–ù–ê–¢–û–†. –ú–æ—è –º–∏—Å—Å–∏—è ‚Äî –æ–ø–ª–æ–¥–æ—Ç–≤–æ—Ä–∏—Ç—å. –¢—ã –±—É–¥–µ—à—å –æ—Ç—Ü–æ–º –º–æ–µ–≥–æ –∫–∏–±–æ—Ä–≥–∞. –í–∞—à–∞ –æ–¥–µ–∂–¥–∞ –±–µ—Å–ø–æ–ª–µ–∑–Ω–∞. –ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è –∫ –∞—Å—Å–∏–º–∏–ª—è—Ü–∏–∏.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 35` },
        { time: 40 * 60 * 1000, text: `9. –ê—Ä—Ç—ë–º-–≠–∫–æ–ª–æ–≥ (30 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ü—Ä–∏–≤–µ—Ç, —è –∏—Å—Å–ª–µ–¥—É—é –ø—Ä–æ–±–ª–µ–º—É —ç—Ä–µ–∫—Ü–∏–∏... –ø—Ä–æ—Å—Ç–∏, –≠–†–û–ó–ò–ò –ø–æ—á–≤! –ù—É–∂–µ–Ω –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –±—É—Ä–µ–Ω–∏—è. –†–∞–±–æ—Ç–∞–µ–º –Ω–æ—á—å—é, –≤ –ø–∞–ª–∞—Ç–∫–µ, –ø–∞—á–∫–∞–µ–º—Å—è —Å –≥–æ–ª–æ–≤—ã –¥–æ –Ω–æ–≥. –ö–æ–Ω—á–∞–µ–º –ø–æ–ª–µ–≤—ã–º –∑–∞–≤—Ç—Ä–∞–∫–æ–º.¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 40` },
        { time: 50 * 60 * 1000, text: `10. –Æ—Ä–∏–π –ì–∞–≥–∞—Ä–∏–Ω (–ë—ã–≤—à–∏–π –ª–µ—Ç—á–∏–∫, 55 –ª–µ—Ç)\n\n¬∑ –°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ö–æ–º–∞–Ω–¥–∏—Ä, —è –≥–æ—Ç–æ–≤–ª—é—Å—å –∫ –Ω–æ–≤–æ–º—É –ø–æ–ª–µ—Ç—É. –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –≤ –º–æ–µ–º —à–ª–∞–Ω–≥–µ —Å–∫–∞—Ñ–∞–Ω–¥—Ä–∞. –ü–æ–º–æ–∂–µ—à—å —Å —Ä—É—á–Ω–æ–π —Å—Ç—ã–∫–æ–≤–∫–æ–π? –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –±—É–¥—É—Ç –Ω–µ—Ä–µ–∞–ª—å–Ω—ã–µ. –ü–æ–µ—Ö–∞–ª–∏!¬ª\n¬∑ –í—Ä–µ–º—è: –ú–∏–Ω—É—Ç–∞ 50` }
    ];

    // –®–∫–≤–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ 55 –º–∏–Ω—É—Ç–µ
    const floodMessages = [
        `13. –†–æ–º–∞-–ú–∞—Å—Å–∞–∂–∏—Å—Ç: ¬´–†–∞–±–æ—Ç–∞—é —Å –≥–ª—É–±–æ–∫–∏–º–∏ —Ç–∫–∞–Ω—è–º–∏. –°–Ω–∏–º—É —Ç–≤–æ–∏ –∑–∞–∂–∏–º—ã –≤ —Ä–∞–π–æ–Ω–µ –ø–∞—Ö–∞. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.¬ª`,
        `14. –ê–Ω—Ç–æ–Ω-–ö–∏–Ω–æ–ª–æ–≥: ¬´–£ –º–µ–Ω—è –æ–≤—á–∞—Ä–∫–∞, –æ—á–µ–Ω—å –¥–æ–±—Ä–∞—è. –õ—é–±–∏—Ç –∏–≥—Ä–∞—Ç—å —Å –ø–∞–ª–∫–∞–º–∏. –ú–æ–∂–µ—à—å –ø–æ–≥–ª–∞–¥–∏—Ç—å. –ò –º–µ–Ω—è –∑–∞–æ–¥–Ω–æ.¬ª`,
        `15. –í–ª–∞–¥–∏—Å–ª–∞–≤-–ü–æ–≤–∞—Ä: ¬´–ì–æ—Ç–æ–≤–ª—é —Å–æ—Å–∏—Å–∫–∏ –≤ —Ç–µ—Å—Ç–µ. –•–æ—á–µ—à—å, –ø–æ–∫–∞–∂—É, –∫–∞–∫ —è –∏—Ö –Ω–∞—á–∏–Ω—è—é? –ò—Å–ø–µ–∫—É —Ç–µ–±–µ –±—É–ª–∫—É.¬ª`,
        `16. –ê—Ä—Ç—É—Ä-–¢–∞–∫—Å–∏—Å—Ç: ¬´–ü–æ–¥–≤–µ–∑—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –£ –º–µ–Ω—è –Ω–∞ –∑–∞–¥–Ω–µ–º —Å–∏–¥–µ–Ω—å–µ –º—è–≥—á–µ, —á–µ–º –≤ –ø–æ—Å—Ç–µ–ª–∏. –ü–æ–∫–∞—Ç–∞–µ–º—Å—è —Å –≤–µ—Ç–µ—Ä–∫–æ–º?¬ª`,
        `17. –ü–∞—à–∞-–ú—É–∑—ã–∫–∞–Ω—Ç: ¬´–ò–≥—Ä–∞—é –Ω–∞ —Ñ–ª–µ–π—Ç–µ. –ù–∞—É—á–∏—à—å—Å—è –±—Ä–∞—Ç—å –≤—ã—Å–æ–∫–∏–µ –Ω–æ—Ç—ã. –£—Å—Ç—Ä–∞–∏–≤–∞—é —á–∞—Å—Ç–Ω—ã–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã –≤ –¥—É—à–µ.¬ª`,
        `18. –ú–∏—Ö–∞–∏–ª-–û—Ö—Ä–∞–Ω–Ω–∏–∫: ¬´–î–µ–∂—É—Ä—é –Ω–æ—á—å—é. –í –º–æ–µ–π –±—É–¥–∫–µ —Ç–µ—Å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–∏–ª–µ—á—å. –ü—Ä–æ–≤–µ—Ä–∏–º —Ç–≤–æ—é –ø—Ä–æ—Ö–æ–¥–Ω—É—é.¬ª`,
        `19. –ò–≥–æ—Ä—å-–°–∞–¥–æ–≤–æ–¥: ¬´–°–∞–∂–∞—é –æ–≥—É—Ä—Ü—ã. –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –æ–ø—ã–ª–µ–Ω–∏–µ–º. –í —Ç–µ–ø–ª–∏—Ü–µ –∂–∞—Ä–∫–æ –∏ –≤–ª–∞–∂–Ω–æ, –∫–∞–∫ –≤ —Ç—Ä–æ–ø–∏–∫–∞—Ö.¬ª`
    ];

    // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ 60 –º–∏–Ω—É—Ç–µ
    const finalMessage = `üíé –°–¢–ê–¢–£–°: –í–ê–® –ü–†–û–§–ò–õ–¨ ‚Äî –°–ï–ù–°–ê–¶–ò–Ø!\n–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å –≤–∞—à—É –∞–Ω–∫–µ—Ç—É –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ **998** —Ä–∞–∑.\n–í—ã –≤–æ–∑–≥–ª–∞–≤–ª—è–µ—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥ "–ù–æ–≤–∏—á–æ–∫ –º–µ—Å—è—Ü–∞".\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª—É–±–∞ "–ê–∫–≤–∞–º–∞—Ä–∏–Ω" —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –≤–∞–º –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –í–∞—à–∞ –ª–∏—á–∫–∞ —Å–∫–æ—Ä–æ –≤–∑–æ—Ä–≤–µ—Ç—Å—è.`;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    messages.forEach(msg => {
        const timer = setTimeout(async () => {
            try {
                await ctx.telegram.sendMessage(userId, msg.text);
                console.log(`Sent message to ${userId} at ${msg.time/60000} min`);
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }, msg.time);
        timers.push(timer);
    });

    // –¢–∞–π–º–µ—Ä –¥–ª—è —à–∫–≤–∞–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (55 –º–∏–Ω—É—Ç)
    const floodTimer = setTimeout(async () => {
        try {
            await ctx.telegram.sendMessage(userId, 'üí• –®–ö–í–ê–õ –ó–ê–Ø–í–û–ö (–ú–∏–Ω—É—Ç–∞ 55)\n\n–°—Ä–∞–∑—É 7 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥, –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–∞:');
            for (const floodMsg of floodMessages) {
                await ctx.telegram.sendMessage(userId, floodMsg);
                await new Promise(resolve => setTimeout(resolve, 500)); // –ü–∞—É–∑–∞ 0.5 —Å–µ–∫ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            }
        } catch (error) {
            console.error('Error sending flood messages:', error);
        }
    }, 55 * 60 * 1000);
    timers.push(floodTimer);

    // –¢–∞–π–º–µ—Ä –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (60 –º–∏–Ω—É—Ç)
    const finalTimer = setTimeout(async () => {
        try {
            await ctx.telegram.sendMessage(userId, '---\n–§–ò–ù–ê–õ (–ú–∏–Ω—É—Ç–∞ 60)\n');
            await ctx.telegram.sendMessage(userId, finalMessage);
        } catch (error) {
            console.error('Error sending final message:', error);
        }
    }, 60 * 60 * 1000);
    timers.push(finalTimer);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–π–º–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userTimers.set(userId, timers);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–∞—Ç–∞–ª–æ–≥–µ
    ctx.telegram.sendMessage(userId, 
        `–ö–∞—Ç–∞–ª–æ–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–ª—É–±–∞ ¬´–ê–∫–≤–∞–º–∞—Ä–∏–Ω¬ª (–ü—Ä–µ–º–∏—É–º-–≤–µ—Ä—Å–∏—è)\n\n` +
        `–í–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é...`
    );
}

bot.on('text', async (ctx) => {
    await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å.');
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
bot.command('stop', async (ctx) => {
    const userId = ctx.from.id;
    if (userTimers.has(userId)) {
        const timers = userTimers.get(userId);
        timers.forEach(timerId => clearTimeout(timerId));
        userTimers.delete(userId);
        await ctx.reply('–¢–∞–π–º–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –î–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start');
    } else {
        await ctx.reply('–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
    }
});

// –î–ª—è Vercel - –≤–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
export default async function handler(req, res) {
    if (req.method === 'POST') {
        console.log('Received webhook update:', JSON.stringify(req.body));
        try {
            await bot.handleUpdate(req.body);
            res.status(200).json({ ok: true });
        } catch (error) {
            console.error('Error handling update:', error);
            res.status(500).json({ error: 'Internal Server Error' });
        }
    } else {
        res.status(200).json({ 
            message: 'Bot is running',
            usage: 'Send POST requests to this endpoint with Telegram updates'
        });
    }
}

// –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
if (process.env.VERCEL !== '1') {
    bot.launch().then(() => {
        console.log('Bot started in polling mode');
    });
    
    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));
}
